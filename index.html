<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçâReceipt&Sales Management of ‡∏ú‡∏•‡πÑ‡∏°‡πâBy‡πÄ‡∏à‡πä‡πÄ‡∏ô‡∏≤‡∏ß‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Animation for adding/removing item rows */
        .item-row {
            transition: all 0.4s ease-out;
            overflow: hidden;
            max-height: 100px;
        }
        .item-row.new-item {
            max-height: 0;
            opacity: 0;
            transform: translateY(-10px);
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-[Sarabun]">

    <div class="container mx-auto p-4 md:p-8">

        <section id="form-section">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/80">
                <h1 class="text-3xl font-bold text-emerald-600 mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="invoice-date" class="block text-sm font-medium text-slate-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="invoice-date" class="w-full p-2 border border-slate-200 rounded-lg transition-all duration-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="invoice-number" class="block text-sm font-medium text-slate-600 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label>
                        <input type="text" id="invoice-number" class="w-full p-2 border border-slate-200 rounded-lg bg-slate-100" readonly>
                    </div>
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-slate-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="customer-name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full p-2 border border-slate-200 rounded-lg transition-all duration-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>
                <h2 class="text-xl font-semibold text-slate-700 mb-3 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div id="item-list" class="space-y-3"></div>
                <button id="add-item-btn" class="mt-4 flex items-center gap-2 text-sm font-medium bg-emerald-500 text-white py-2 px-4 rounded-lg hover:bg-emerald-600 transition-all duration-300">
                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
                <div class="mt-8 border-t pt-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="col-span-2 md:col-start-3 space-y-2">
                            <div class="flex justify-between text-slate-600">
                                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î):</span>
                                <span id="subtotal-display" class="font-semibold">0.00</span>
                            </div>
                             <div class="flex justify-between text-slate-600">
                                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥:</span>
                                <span id="total-deposit" class="font-semibold">0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-slate-600">
                                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                                <input type="number" id="discount-amount" class="w-1/3 p-1 border border-slate-200 rounded-lg text-right font-semibold text-red-500 transition-all duration-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="0.00" min="0">
                            </div>
                            <div class="flex justify-between text-slate-800 text-2xl font-bold mt-2 border-t pt-2">
                                <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                                <span id="grand-total" class="text-emerald-600">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <label for="payment-method" class="block text-sm font-medium text-slate-600 mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <select id="payment-method" class="w-full md:w-1/3 p-2 border border-slate-200 rounded-lg transition-all duration-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                        <option value="‡πÇ‡∏≠‡∏ô (QR Code)">‡πÇ‡∏≠‡∏ô (QR Code)</option>
                        <option value="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
                        <option value="‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>
                <div class="mt-8 flex flex-wrap gap-3">
                    <button id="generate-receipt-btn" class="flex-1 bg-emerald-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-emerald-700 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-invoice"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
                    </button>
                    <button id="view-report-btn" class="flex-1 bg-slate-700 text-white py-3 px-6 rounded-lg font-semibold hover:bg-slate-800 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-chart-line"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
                    </button>
                    <button id="view-products-btn" class="flex-1 bg-sky-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-sky-700 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-box-archive"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                </div>
            </div>
        </section>

        <section id="receipt-section" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/80">
                <div id="receipt-preview" class="p-8 border border-slate-200 rounded-lg bg-white">
                     <div class="flex justify-between items-start mb-8">
                        <div>
                            <h2 class="text-5xl font-bold text-emerald-600">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
                            <p class="text-lg text-slate-500 mt-2" id="receipt-inv-num"></p>
                            <p class="text-lg text-slate-500" id="receipt-date"></p>
                            <p class="text-lg text-slate-500" id="receipt-time"></p>
                        </div>
                        <div class="text-right">
                           <h3 class="font-bold text-5xl">‡∏ú‡∏•‡πÑ‡∏°‡πâBy‡πÄ‡∏à‡πä‡πÄ‡∏ô‡∏≤‡∏ß‡πå</h3>
                           <p class="text-2xl text-slate-500 mt-2">‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</p>
                           <p class="text-2xl text-slate-500">‡πÇ‡∏ó‡∏£. 081-114-7477</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div>
                            <h4 class="font-semibold text-2xl text-slate-700">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</h4>
                            <p id="receipt-customer" class="text-2xl"></p>
                        </div>
                         <div>
                            <h4 class="font-semibold text-2xl text-slate-700">‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</h4>
                            <p id="receipt-payment-method" class="text-2xl"></p>
                        </div>
                    </div>
                    <table class="w-full mb-8">
                        <thead class="border-b-2 border-slate-300">
                            <tr>
                                <th class="text-left py-1 px-1 font-semibold text-2xl">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th class="text-right py-1 px-1 font-semibold text-2xl">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th class="text-right py-1 px-1 font-semibold text-2xl">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</th>
                                <th class="text-right py-1 px-1 font-semibold text-2xl">‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                <th class="text-right py-1 px-1 font-semibold text-2xl">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                            </tr>
                        </thead>
                        <tbody id="receipt-item-list"></tbody>
                        <tfoot class="border-t-2 border-slate-300 font-semibold text-2xl">
                            <tr>
                                <td colspan="4" class="text-right py-1 px-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥):</td>
                                <td id="receipt-subtotal" class="text-right py-1 px-1"></td>
                            </tr>
                             <tr>
                                <td colspan="4" class="text-right py-1 px-1">‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥:</td>
                                <td id="receipt-total-deposit" class="text-right py-1 px-1"></td>
                            </tr>
                             <tr>
                                <td colspan="4" class="text-right py-1 px-1 text-red-500">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</td>
                                <td id="receipt-discount" class="text-right py-1 px-1 text-red-500"></td>
                            </tr>
                             <tr class="text-4xl">
                                <td colspan="4" class="text-right py-2 px-1 font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó):</td>
                                <td id="receipt-grand-total" class="text-right py-2 px-1 font-bold text-emerald-600"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="text-center text-xl text-slate-500 mt-4">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö</div>
                </div>
                <div class="mt-6 flex flex-wrap gap-3">
                     <button id="download-pdf-btn" class="flex-1 bg-sky-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-sky-700 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="back-to-form-btn flex-1 bg-slate-200 text-slate-800 py-3 px-6 rounded-lg font-semibold hover:bg-slate-300 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </div>
        </section>

        <section id="product-section" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/80">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-slate-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
                    <button class="back-to-form-btn bg-slate-200 text-slate-800 py-2 px-4 rounded-lg font-semibold hover:bg-slate-300 transition-all duration-300 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>
                <div class="mb-6">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-slate-50 p-4 rounded-lg">
                        <input type="hidden" id="product-id">
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-slate-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <input type="text" id="product-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏ó‡∏≠‡∏á" required class="w-full p-2 border border-slate-200 rounded-lg">
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-slate-600 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                            <input type="number" id="product-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" min="0" step="0.01" class="w-full p-2 border border-slate-200 rounded-lg">
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button type="submit" class="flex-1 bg-emerald-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                                <i class="fa-solid fa-save"></i> <span id="product-form-btn-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                            </button>
                            <button type="button" id="cancel-edit-btn" class="hidden flex-1 bg-slate-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-slate-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </div>
                    </form>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-slate-200 rounded-lg">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 text-left text-sm font-semibold text-slate-600">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="p-3 text-right text-sm font-semibold text-slate-600">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th class="p-3 text-center text-sm font-semibold text-slate-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-container">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="report-section" class="hidden">
             <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/80">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
                    <button class="back-to-form-btn bg-slate-200 text-slate-800 py-2 px-4 rounded-lg font-semibold hover:bg-slate-300 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                    <div id="dashboard-summary" class="lg:col-span-2 grid grid-cols-1 gap-4 content-start">
                        <div class="bg-sky-100 text-sky-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div id="sales-today" class="text-2xl font-bold mt-1">0.00</div>
                        </div>
                        <div class="bg-emerald-100 text-emerald-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                            <div id="sales-last-7-days" class="text-2xl font-bold mt-1">0.00</div>
                        </div>
                        <div class="bg-amber-100 text-amber-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div id="sales-this-month" class="text-2xl font-bold mt-1">0.00</div>
                        </div>
                        <div class="bg-red-100 text-red-800 p-4 rounded-lg shadow-sm">
                            <div class="text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div id="sales-pending" class="text-2xl font-bold mt-1">0.00</div>
                        </div>
                    </div>
                    <div class="lg:col-span-3 p-4 bg-slate-50 rounded-lg">
                        <h2 class="text-xl font-bold text-slate-800 mb-3">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                        <div class="relative h-80">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 p-4 bg-slate-50 rounded-lg">
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à..." class="lg:col-span-2 w-full p-2 border border-slate-200 rounded-lg">
                    <select id="filter-payment" class="w-full p-2 border border-slate-200 rounded-lg">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</option>
                        <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                        <option value="‡πÇ‡∏≠‡∏ô (QR Code)">‡πÇ‡∏≠‡∏ô (QR Code)</option>
                        <option value="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
                        <option value="‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                    <input type="date" id="start-date-filter" class="w-full p-2 border border-slate-200 rounded-lg" title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô">
                    <input type="date" id="end-date-filter" class="w-full p-2 border border-slate-200 rounded-lg" title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î">
                </div>
                <div id="report-container" class="space-y-8"></div>
            </div>
        </section>
    </div>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-5 rounded-lg flex items-center gap-4">
             <i class="fa-solid fa-spinner fa-spin text-2xl text-emerald-600"></i>
             <span class="text-lg font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwDdXfjDErN_szx28dHTNgujW8LR_fq2uLwyIfF_eoh4cSjneqC3kumbfLlRIg4fjH2/exec';

            // --- DOM Elements ---
            const sections = {
                form: document.getElementById('form-section'),
                receipt: document.getElementById('receipt-section'),
                report: document.getElementById('report-section'),
                product: document.getElementById('product-section'),
            };
            const invoiceDate = document.getElementById('invoice-date');
            const invoiceNumber = document.getElementById('invoice-number');
            const customerName = document.getElementById('customer-name');
            const itemList = document.getElementById('item-list');
            const addItemBtn = document.getElementById('add-item-btn');
            const subtotalDisplayEl = document.getElementById('subtotal-display');
            const totalDepositEl = document.getElementById('total-deposit');
            const discountAmountEl = document.getElementById('discount-amount');
            const grandTotalEl = document.getElementById('grand-total');
            const paymentMethod = document.getElementById('payment-method');
            const generateReceiptBtn = document.getElementById('generate-receipt-btn');
            const viewReportBtn = document.getElementById('view-report-btn');
            const viewProductsBtn = document.getElementById('view-products-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const receiptPreview = document.getElementById('receipt-preview');
            const receiptInvNum = document.getElementById('receipt-inv-num');
            const receiptDate = document.getElementById('receipt-date');
            const receiptTime = document.getElementById('receipt-time');
            const receiptCustomer = document.getElementById('receipt-customer');
            const receiptPaymentMethod = document.getElementById('receipt-payment-method');
            const receiptItemList = document.getElementById('receipt-item-list');
            const receiptSubtotal = document.getElementById('receipt-subtotal');
            const receiptTotalDeposit = document.getElementById('receipt-total-deposit');
            const receiptDiscount = document.getElementById('receipt-discount');
            const receiptGrandTotal = document.getElementById('receipt-grand-total');
            const reportContainer = document.getElementById('report-container');
            const searchInput = document.getElementById('search-input');
            const filterPayment = document.getElementById('filter-payment');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const productForm = document.getElementById('product-form');
            const productIdInput = document.getElementById('product-id');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const productFormBtnText = document.getElementById('product-form-btn-text');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const productListContainer = document.getElementById('product-list-container');
            
            const salesTodayEl = document.getElementById('sales-today');
            const salesLast7DaysEl = document.getElementById('sales-last-7-days');
            const salesThisMonthEl = document.getElementById('sales-this-month');
            const salesPendingEl = document.getElementById('sales-pending'); // NEW
            const salesChartCanvas = document.getElementById('sales-chart');
            let salesChart = null;

            let allSalesData = [];
            let products = [];
            let currentFilteredData = [];

            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });

            function init() {
                loadProducts();
                resetForm();
                setupEventListeners();
            }

            // --- Product Management Functions ---
            function loadProducts() {
                const storedProducts = localStorage.getItem('fruitShopProducts');
                products = storedProducts ? JSON.parse(storedProducts) : [];
                renderProductList();
            }

            function saveProducts() {
                localStorage.setItem('fruitShopProducts', JSON.stringify(products));
                renderProductList();
                document.querySelectorAll('.product-select').forEach(select => {
                    const selectedValue = select.value;
                    populateProductDropdown(select);
                    select.value = selectedValue;
                });
            }

            function renderProductList() {
                productListContainer.innerHTML = '';
                if(products.length === 0){
                    productListContainer.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</td></tr>`;
                    return;
                }
                products.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-t';
                    tr.innerHTML = `
                        <td class="p-3">${p.name}</td>
                        <td class="p-3 text-right font-medium">
                            ${p.price > 0 ? `${parseFloat(p.price).toFixed(2)}` : '<span class="text-slate-400">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>'}
                        </td>
                        <td class="p-3 text-center">
                            <button class="edit-product-btn text-sky-500 hover:text-sky-700 mr-2" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="delete-product-btn text-red-500 hover:text-red-700" data-id="${p.id}"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                    productListContainer.appendChild(tr);
                });
            }
            
            function handleProductFormSubmit(e) {
                e.preventDefault();
                const id = productIdInput.value;
                const name = productNameInput.value.trim();
                const price = parseFloat(productPriceInput.value) || 0;

                if (!name) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'warning');
                    return;
                }

                if (id) {
                    const productIndex = products.findIndex(p => p.id == id);
                    if (productIndex > -1) {
                        products[productIndex] = { ...products[productIndex], name, price };
                    }
                } else {
                    products.push({ id: Date.now(), name, price });
                }
                saveProducts();
                resetProductForm();
            }
            
            function resetProductForm(){
                productForm.reset();
                productIdInput.value = '';
                productFormBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
                cancelEditBtn.classList.add('hidden');
            }

            // --- Core Application Functions ---
            function resetForm() {
                const today = new Date().toISOString().split('T')[0];
                invoiceDate.value = today;
                generateInvoiceNumber();
                customerName.value = '';
                itemList.innerHTML = '';
                addItemRow();
                discountAmountEl.value = '';
                updateTotals();
                paymentMethod.value = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            }

            function generateInvoiceNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const randomNum = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
                invoiceNumber.value = `INV-${year}${month}${day}-${randomNum}`;
            }

            function setupEventListeners() {
                addItemBtn.addEventListener('click', addItemRow);
                itemList.addEventListener('input', updateTotals);
                discountAmountEl.addEventListener('input', updateTotals);
                itemList.addEventListener('change', (e) => {
                    if (e.target.classList.contains('product-select')) {
                        const selectedProductId = e.target.value;
                        const product = products.find(p => p.id == selectedProductId);
                        const priceInput = e.target.closest('.item-row').querySelector('.price-input');
                        if (product) {
                            priceInput.value = product.price > 0 ? product.price : '';
                            if (product.price <= 0) {
                                priceInput.focus();
                            }
                        } else {
                            priceInput.value = '';
                        }
                    }
                    updateTotals();
                });
                
                generateReceiptBtn.addEventListener('click', handleGenerateReceipt);
                downloadPdfBtn.addEventListener('click', handleDownloadAndSave);
                viewReportBtn.addEventListener('click', () => {
                    showSection('report');
                    fetchSalesData();
                });
                viewProductsBtn.addEventListener('click', () => showSection('product'));

                document.querySelectorAll('.back-to-form-btn').forEach(btn => {
                    btn.addEventListener('click', () => showSection('form'));
                });
                
                searchInput.addEventListener('input', renderReport);
                filterPayment.addEventListener('change', renderReport);
                startDateFilter.addEventListener('change', renderReport);
                endDateFilter.addEventListener('change', renderReport);
                
                itemList.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-item-btn')) {
                        const rowToRemove = e.target.closest('.item-row');
                        // Animation part for removal
                        rowToRemove.style.maxHeight = '0';
                        rowToRemove.style.opacity = '0';
                        rowToRemove.style.padding = '0';
                        rowToRemove.style.margin = '0';
                        setTimeout(() => {
                           rowToRemove.remove();
                           updateTotals();
                        }, 400); // Match CSS transition duration
                    }
                });

                productForm.addEventListener('submit', handleProductFormSubmit);
                cancelEditBtn.addEventListener('click', resetProductForm);
                productListContainer.addEventListener('click', e => {
                    const editBtn = e.target.closest('.edit-product-btn');
                    const deleteBtn = e.target.closest('.delete-product-btn');
                    if (editBtn) {
                        const productId = editBtn.dataset.id;
                        const product = products.find(p => p.id == productId);
                        if(product){
                            productIdInput.value = product.id;
                            productNameInput.value = product.name;
                            productPriceInput.value = product.price > 0 ? product.price : '';
                            productFormBtnText.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                            cancelEditBtn.classList.remove('hidden');
                            productNameInput.focus();
                        }
                    }
                    if (deleteBtn) {
                        const productId = deleteBtn.dataset.id;
                        products = products.filter(p => p.id != productId);
                        saveProducts();
                    }
                });
            }

            function addItemRow() {
                const row = document.createElement('div');
                row.className = 'item-row grid grid-cols-12 gap-2 items-center new-item';
                row.innerHTML = `
                    <select class="product-select col-span-12 md:col-span-4 p-2 border rounded-lg bg-white"></select>
                    <input type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢" class="price-input col-span-6 md:col-span-2 p-2 border rounded-lg" min="0">
                    <input type="number" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="col-span-6 md:col-span-2 p-2 border rounded-lg" min="0" step="0.1">
                    <select class="col-span-8 md:col-span-2 p-2 border rounded-lg bg-white">
                        <option value="0">‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</option>
                        <option value="100">‡∏°‡∏±‡∏î‡∏à‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</option>
                        <option value="200">‡∏°‡∏±‡∏î‡∏à‡∏≥ 200 ‡∏ö‡∏≤‡∏ó</option>
                    </select>
                    <span class="item-total col-span-3 md:col-span-1 text-right font-semibold text-slate-700">0.00</span>
                    <button class="delete-item-btn col-span-1 text-red-500 hover:text-red-700 text-center"><i class="fa-solid fa-trash-can"></i></button>
                `;
                const productSelect = row.querySelector('.product-select');
                populateProductDropdown(productSelect);
                itemList.appendChild(row);

                requestAnimationFrame(() => {
                    row.classList.remove('new-item');
                });
            }

            function populateProductDropdown(selectElement) {
                selectElement.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
                products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    selectElement.appendChild(option);
                });
            }

            function updateTotals() {
                let subtotal = 0;
                let totalDeposit = 0;

                itemList.querySelectorAll('.item-row').forEach(row => {
                    const price = parseFloat(row.children[1].value) || 0;
                    const weight = parseFloat(row.children[2].value) || 0;
                    const deposit = parseFloat(row.children[3].value) || 0;
                    const itemSubtotal = price * weight;
                    const itemTotal = itemSubtotal + deposit;
                    row.querySelector('.item-total').textContent = `${itemTotal.toFixed(2)}`;
                    
                    subtotal += itemSubtotal;
                    totalDeposit += deposit;
                });

                const discount = parseFloat(discountAmountEl.value) || 0;
                const grandTotal = subtotal - discount + totalDeposit;

                subtotalDisplayEl.textContent = `${subtotal.toFixed(2)}`;
                totalDepositEl.textContent = `${totalDeposit.toFixed(2)}`;
                grandTotalEl.textContent = `${grandTotal.toFixed(2)}`;
            }
            
            function handleGenerateReceipt() {
                 if (!customerName.value.trim()) {
                    Swal.fire({
                        icon: 'info',
                        title: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤',
                        text: '‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                        confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
                        confirmButtonColor: '#10b981',
                        timer: 3000,
                        timerProgressBar: true
                    });
                    customerName.focus();
                    return;
                }

                receiptInvNum.textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${invoiceNumber.value}`;
                receiptDate.textContent = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(invoiceDate.value).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}`;
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                receiptTime.textContent = `‡πÄ‡∏ß‡∏•‡∏≤: ${timeString}`;
                
                receiptCustomer.textContent = customerName.value;
                receiptPaymentMethod.textContent = paymentMethod.value;

                receiptItemList.innerHTML = '';
                let subtotal = 0, totalDeposit = 0;

                itemList.querySelectorAll('.item-row').forEach(row => {
                    const selectedOption = row.querySelector('.product-select option:checked');
                    const name = selectedOption.textContent;
                    const price = parseFloat(row.children[1].value) || 0;
                    const weight = parseFloat(row.children[2].value) || 0;
                    const deposit = parseFloat(row.children[3].value) || 0;
                    if (name && (price > 0 || weight > 0) && selectedOption.value) {
                        const itemSubtotal = price * weight;
                        const itemTotal = itemSubtotal + deposit;
                        subtotal += itemSubtotal;
                        totalDeposit += deposit;
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-slate-100';
                        tr.innerHTML = `<td class="py-2 px-1 text-left text-2xl">${name}</td><td class="py-2 px-1 text-right text-2xl">${price.toFixed(2)}</td><td class="py-2 px-1 text-right text-2xl">${weight.toFixed(2)}</td><td class="py-2 px-1 text-right text-2xl">${deposit.toFixed(2)}</td><td class="py-2 px-1 text-right font-medium text-2xl">${itemTotal.toFixed(2)}</td>`;
                        receiptItemList.appendChild(tr);
                    }
                });
                
                const discount = parseFloat(discountAmountEl.value) || 0;
                const grandTotal = subtotal - discount + totalDeposit;

                receiptSubtotal.textContent = `${subtotal.toFixed(2)}`;
                receiptTotalDeposit.textContent = `${totalDeposit.toFixed(2)}`;
                receiptDiscount.textContent = `-${discount.toFixed(2)}`;
                receiptGrandTotal.textContent = `${grandTotal.toFixed(2)}`;
                showSection('receipt');
            }

            async function handleDownloadAndSave() {
                loadingOverlay.classList.remove('hidden');

                const now = new Date();
                const timeString = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                const data = {
                    invoiceId: invoiceNumber.value,
                    date: invoiceDate.value,
                    time: timeString,
                    customerName: customerName.value,
                    totalAmount: parseFloat(grandTotalEl.textContent), // This is already the final amount after discount
                    totalDeposit: parseFloat(totalDepositEl.textContent),
                    paymentMethod: paymentMethod.value
                };

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.status !== 'success') {
                        throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏à‡∏≤‡∏Å Google Sheets');
                    }
                    
                    Toast.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        html: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
                    });

                    try {
                        const canvas = await html2canvas(receiptPreview, { scale: 2 });
                        const imgData = canvas.toDataURL('image/jpeg', 0.92);
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                        const imgProps = doc.getImageProperties(imgData);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        doc.save(`${invoiceNumber.value}.pdf`);
                        
                        resetForm();
                        showSection('form');

                    } catch (pdfError) {
                        console.error("PDF Generation Error:", pdfError);
                        Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'warning');
                    }

                } catch (saveError) {
                    console.error('Google Sheets Save Error:', saveError);
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${saveError.message}`, 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }

            async function fetchSalesData() {
                reportContainer.innerHTML = `<div class="text-center p-8 text-slate-500"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>`;
                try {
                    const response = await fetch(SCRIPT_URL);
                    allSalesData = await response.json();
                    allSalesData.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                    renderReport();
                } catch (error) {
                    reportContainer.innerHTML = `<div class="text-center p-8 text-red-500"><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p></div>`;
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
                }
            }
            
            function formatDateForReport(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleDateString('th-TH');
            }

            function renderReport() {
                const searchTerm = searchInput.value.toLowerCase();
                const paymentFilter = filterPayment.value;
                const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;
                if(startDate) startDate.setHours(0, 0, 0, 0);
                if(endDate) endDate.setHours(23, 59, 59, 999);

                currentFilteredData = allSalesData.filter(item => {
                    const itemDate = new Date(item.Date);
                    if (isNaN(itemDate.getTime())) return false;
                    return (item.CustomerName.toLowerCase().includes(searchTerm) || item.InvoiceID.toLowerCase().includes(searchTerm)) &&
                           (paymentFilter === 'all' || item.PaymentMethod === paymentFilter) &&
                           (!startDate || itemDate >= startDate) &&
                           (!endDate || itemDate <= endDate);
                });
                
                updateDashboard(allSalesData); 
                renderSalesChart(allSalesData); 

                const groupedByDay = currentFilteredData.reduce((acc, item) => {
                    const date = new Date(item.Date);
                    if (isNaN(date.getTime())) return acc;
                    const day = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(item);
                    return acc;
                }, {});

                reportContainer.innerHTML = '';
                if (Object.keys(groupedByDay).length === 0) {
                    reportContainer.innerHTML = `<div class="text-center p-12 border-2 border-dashed rounded-lg"> <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"> <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /> </svg> <h3 class="mt-2 text-lg font-medium text-slate-900">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3> <p class="mt-1 text-sm text-slate-500"> ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà </p> </div>`;
                    return;
                }
                
                for (const day in groupedByDay) {
                    const items = groupedByDay[day];
                    const dayTotal = items.reduce((sum, item) => sum + item.TotalAmount, 0);
                    const daySection = document.createElement('div');
                    
                    const tableRows = items.map(item => {
                        let paymentStatusHtml = (item.PaymentMethod === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞') 
                            ? `<span class="text-red-500 font-semibold">${item.PaymentMethod}</span>` 
                            : `<span>${item.PaymentMethod}</span>`;

                        let manageButtonHtml = (item.PaymentMethod === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞') 
                            ? `<button class="edit-payment-btn text-sky-500 hover:text-sky-700" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" data-invoice-id="${item.InvoiceID}"><i class="fa-solid fa-pen-to-square"></i></button>` 
                            : '';

                        return `<tr class="border-t">
                            <td class="p-3">${formatDateForReport(item.Date)}</td>
                            <td class="p-3">${item.CustomerName}</td>
                            <td class="p-3 text-slate-500">${item.InvoiceID}</td>
                            <td class="p-3 text-right font-medium">${item.TotalAmount.toFixed(2)}</td>
                            <td class="p-3 text-right text-blue-600">${item.TotalDeposit.toFixed(2)}</td>
                            <td class="p-3">${paymentStatusHtml}</td>
                            <td class="p-3 text-center">${manageButtonHtml}</td>
                        </tr>`;
                    }).join('');

                    daySection.innerHTML = `
                        <div class="flex justify-between items-baseline mb-3">
                            <h2 class="text-xl font-bold text-slate-800">${day}</h2>
                            <p class="text-lg font-semibold text-emerald-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô: ${dayTotal.toFixed(2)}</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-slate-200 rounded-lg">
                                <thead class="bg-slate-100">
                                    <tr>
                                        <th class="p-3 text-left text-sm font-semibold text-slate-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="p-3 text-left text-sm font-semibold text-slate-600">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="p-3 text-left text-sm font-semibold text-slate-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                                        <th class="p-3 text-right text-sm font-semibold text-slate-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                        <th class="p-3 text-right text-sm font-semibold text-slate-600">‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                        <th class="p-3 text-left text-sm font-semibold text-slate-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                                        <th class="p-3 text-center text-sm font-semibold text-slate-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>`;
                    reportContainer.appendChild(daySection);
                }
            }
            
            function updateDashboard(data) {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const sevenDaysAgoStart = new Date();
                sevenDaysAgoStart.setDate(now.getDate() - 6);
                sevenDaysAgoStart.setHours(0, 0, 0, 0);
                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

                const salesToday = data.filter(item => new Date(item.Date) >= todayStart).reduce((sum, item) => sum + item.TotalAmount, 0);
                const sales7Days = data.filter(item => new Date(item.Date) >= sevenDaysAgoStart).reduce((sum, item) => sum + item.TotalAmount, 0);
                const salesMonth = data.filter(item => new Date(item.Date) >= thisMonthStart).reduce((sum, item) => sum + item.TotalAmount, 0);
                const salesPending = data.filter(item => item.PaymentMethod === '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞').reduce((sum, item) => sum + item.TotalAmount, 0); // NEW Calculation

                salesTodayEl.textContent = `${salesToday.toFixed(2)}`;
                salesLast7DaysEl.textContent = `${sales7Days.toFixed(2)}`;
                salesThisMonthEl.textContent = `${salesMonth.toFixed(2)}`;
                salesPendingEl.textContent = `${salesPending.toFixed(2)}`; // NEW Update
            }

            function renderSalesChart(data) {
                const monthlySales = data.reduce((acc, item) => {
                    const itemDate = new Date(item.Date);
                    if (isNaN(itemDate.getTime())) return acc;
                    
                    const yearMonthKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth()).padStart(2, '0')}`;
                    const thaiMonthLabel = itemDate.toLocaleDateString('th-TH', { year: '2-digit', month: 'short' });

                    if (!acc[yearMonthKey]) {
                        acc[yearMonthKey] = { total: 0, label: thaiMonthLabel };
                    }
                    acc[yearMonthKey].total += item.TotalAmount;
                    return acc;
                }, {});

                const sortedMonthKeys = Object.keys(monthlySales).sort();

                const chartLabels = sortedMonthKeys.map(key => monthlySales[key].label);
                const chartData = sortedMonthKeys.map(key => monthlySales[key].total);

                if (salesChart) {
                    salesChart.destroy();
                }
                salesChart = new Chart(salesChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                            data: chartData,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            reportContainer.addEventListener('click', (e) => {
                const editButton = e.target.closest('.edit-payment-btn');
                
                if (editButton) {
                    const invoiceId = editButton.dataset.invoiceId;
                    promptForNewPaymentMethod(invoiceId);
                }
            });

            async function promptForNewPaymentMethod(invoiceId) {
                const { value: newMethod } = await Swal.fire({
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                    text: `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${invoiceId}`,
                    input: 'select',
                    inputOptions: {
                        '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î': '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                        '‡πÇ‡∏≠‡∏ô (QR Code)': '‡πÇ‡∏≠‡∏ô (QR Code)',
                        '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ': '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
                    },
                    inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                    showCancelButton: true,
                    confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                });

                if (newMethod) {
                    handleUpdatePaymentMethod(invoiceId, newMethod);
                }
            }
            
            async function handleUpdatePaymentMethod(invoiceId, newMethod) {
                loadingOverlay.classList.remove('hidden');
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'updatePayment',
                            invoiceId: invoiceId,
                            newPaymentMethod: newMethod 
                        })
                    });
                    const resData = await response.json();
                    if (resData.status !== 'success') throw new Error(resData.message);
                    Toast.fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
                    fetchSalesData();
                } catch (error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }

            function showSection(sectionKey) {
                Object.values(sections).forEach(section => section.classList.add('hidden'));
                if(sections[sectionKey]) sections[sectionKey].classList.remove('hidden');
            }

            init();
        });
    </script>
</body>
</html>